<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>St. Luke's Safety Training Mission</title>
    <style>
        body { margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background-color: #0f172a; font-family: 'Segoe UI', sans-serif; color: #f7fafc; overflow-x: hidden; user-select: none; touch-action: none; }
        
        #player-form-box { text-align: left; background: #1e293b; padding: 30px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.5); width: 85%; max-width: 400px; z-index: 100; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 12px; color: #60a5fa; margin-bottom: 5px; font-weight: bold; }
        .form-group select, .form-group input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box; }

        .main-controls { width: 90%; max-width: 600px; margin-bottom: 10px; display: none; gap: 10px; align-items: center; background: #1e293b; padding: 10px; border-radius: 12px; box-sizing: border-box; }
        #start-menu { text-align: center; background: #1e293b; padding: 40px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.5); width: 85%; max-width: 400px; display: none; }
        #score { font-size: 22px; font-weight: bold; color: #60a5fa; flex-grow: 1; }

        #game-section { display: none; text-align: center; width: 100%; max-width: 600px; position: relative; }
        canvas { width: 95%; height: auto; border: 3px solid #334155; background-color: #020617; border-radius: 12px; cursor: crosshair; }

        .progress-container { width: 90%; height: 10px; background: #334155; border-radius: 10px; margin: 10px auto; overflow: hidden; }
        .progress-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #60a5fa, #3b82f6); transition: width 0.5s ease; }

        .checkpoint-box { display: none; background: white; padding: 20px 30px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.6); text-align: center; width: 90%; max-width: 850px; color: #1e293b; max-height: 90vh; overflow-y: auto; box-sizing: border-box; z-index: 1000; }

        .diagram-wrapper { position: relative; width: 300px; height: 350px; background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSpPUDif2LkKX4bx3_sXJquY6_nF20kS_56aw&s'); background-size: contain; background-repeat: no-repeat; background-position: center; margin: 0 auto; }
        .part-target { position: absolute; border: 2px solid #3b82f6; background: rgba(59, 130, 246, 0.1); border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; font-size: 6px; font-weight: bold; text-align: center; line-height: 1; pointer-events: auto; }
        .part-target.filled-correct { background: #1e3a8a !important; color: white !important; border-color: #1e40af; pointer-events: none; }
        
        .choice-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; justify-items: center; }
        .choice-box-uniform { width: 130px; padding: 12px 0; background: #2563eb; color: white; border-radius: 6px; cursor: pointer; font-weight: bold; text-align: center; font-size: 11px; touch-action: none; position: relative; pointer-events: auto; }

        /* IPHONE STAGE 2 */
        .iphone-frame { width: 220px; height: 460px; background: #1c1c1e; border-radius: 40px; border: 8px solid #334155; margin: 0 auto; position: relative; padding: 10px; }
        .iphone-notch { width: 100px; height: 20px; background: #334155; position: absolute; top: 0; left: 50%; transform: translateX(-50%); border-bottom-left-radius: 15px; border-bottom-right-radius: 15px; z-index: 10; }
        .iphone-screen { background: #000; height: 100%; border-radius: 30px; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .iphone-display { color: #fff; font-size: 28px; height: 40px; margin-bottom: 20px; letter-spacing: 2px; }
        .iphone-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .iphone-key { width: 55px; height: 55px; background: #3a3a3c; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; }
        .iphone-call { width: 60px; height: 60px; background: #34c759; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 26px; border: none; margin-top: 15px; cursor: pointer; }
        .calling-state { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #34c759; color: white; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 20; }

        .rainbow-grid { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; margin-top: 15px; }
        .rainbow-box { width: 60px; height: 80px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: bold; color: white; text-transform: uppercase; border: 2px solid transparent; }
        .locked { pointer-events: none !important; opacity: 0.5; }
        .selected-correct { border: 3px solid #16a34a !important; opacity: 1 !important; transform: scale(1.05); box-shadow: 0 0 10px #16a34a; }

        .person-container { display: flex; flex-direction: column; align-items: center; margin-bottom: 10px; }
        .person-drag { font-size: 55px; cursor: grab; padding: 5px; background: white; border-radius: 50%; border: 4px solid #3b82f6; touch-action: none; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; }
        .drop-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .drop-zone { border: 2px dashed #94a3b8; border-radius: 12px; padding: 10px; display: flex; align-items: center; justify-content: center; background: #f1f5f9; min-height: 60px; font-size: 11px; font-weight: bold; text-align: center; color: #475569;}
        .filled-correct-grid { background: #dcfce7 !important; border: 2px solid #16a34a !important; color: #166534 !important; }
        .blank-inline { display: inline-flex; width: 100px; height: 30px; border-bottom: 3px solid #3b82f6; margin: 0 5px; vertical-align: middle; justify-content: center; align-items: center; font-weight: bold; color: #1e40af; }

        .btn { padding: 12px 30px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .btn-green { background: #16a34a; color: white; display: none; margin: 15px auto 0; }
        
        /* RACE BOX UNIFORMITY */
        .race-letter-box { padding: 10px; background: #f1f5f9; border-radius: 8px; min-width: 80px; min-height: 70px; text-align: center; font-weight: bold; color: #1e293b; border: 1px solid #cbd5e1; font-size: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1.2; transition: background 0.3s; }
        .completed-box { background: #dcfce7 !important; border-color: #16a34a !important; color: #166534 !important; }
        .code-display-box { font-family: monospace; font-size: 28px; color: #1e293b; background: #e2e8f0; padding: 15px; border-radius: 10px; margin: 20px 0; border: 2px dashed #3b82f6; letter-spacing: 2px; }
    </style>
</head>
<body>

    <div id="player-form-box">
        <h2 style="color: #60a5fa; margin-top:0;">PLAYER DETAILS</h2>
        <div class="form-group">
            <label>I AM FROM ST. LUKE'S MEDICAL CENTER</label>
            <select id="user-location">
                <option value="" disabled selected>Select Location</option>
                <option value="GLOBAL CITY">GLOBAL CITY</option>
                <option value="QUEZON CITY">QUEZON CITY</option>
                <option value="EXTENSION CLINIC">EXTENSION CLINIC</option>
                <option value="COLLEGE OF MEDICINE">COLLEGE OF MEDICINE</option>
            </select>
        </div>
        <div class="form-group">
            <label>I AM PLAYER NO. (EMPLOYEE NO. | DOCTOR'S CODE | STUDENT NO.)</label>
            <input type="text" id="user-id" placeholder="Enter ID here">
        </div>
        <button class="btn" id="form-submit-btn" style="background:#3b82f6; color:white; width:100%; opacity: 0.5;" onclick="saveDetails()">PROCEED</button>
    </div>

    <div id="start-menu">
        <h1 style="color: #60a5fa;">Safety Mission</h1>
        <p>Complete 10 Stages to become a Certified Safety Hero.</p>
        <button class="btn" style="background:#3b82f6; color:white;" onclick="startGame()">START MISSION</button>
    </div>

    <div class="main-controls" id="top-bar">
        <div id="score">Score: 0</div>
        <button onclick="location.reload()" style="background:#ef4444; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-size: 12px;">Reset</button>
    </div>

    <div id="game-section">
        <canvas id="gameCanvas"></canvas>
        <div class="progress-container"><div class="progress-fill" id="p-bar-main"></div></div>
        <p style="color: #94a3b8; font-size: 12px;"><b>Hold SPACE or Click/Tap</b> to spray white extinguisher!</p>
    </div>

    <div id="quiz-section" class="checkpoint-box">
        <h3>Stage 1: Equipment Check</h3>
        <div class="diagram-wrapper">
            <div class="part-target" data-answer="HANDLE" style="top:32px; left:158px;"></div>
            <div class="part-target" data-answer="LEVER" style="top:72px; left:168px;"></div>
            <div class="part-target" data-answer="PIN" style="top:40px; left:133px;"></div>
            <div class="part-target" data-answer="PRESSURE GAUGE" style="top:65px; left:128px;"></div> 
            <div class="part-target" data-answer="HOSE" style="top:130px; left:70px;"></div>
            <div class="part-target" data-answer="NOZZLE" style="top:240px; left:90px;"></div>
        </div>
        <div class="choice-grid" id="s1-choices"></div>
        <button id="quizReturnBtn" class="btn btn-green" onclick="returnToGame('quiz-section')">CONTINUE ‚Üí</button>
    </div>

    <div id="phone-section" class="checkpoint-box">
        <h3>Stage 2: Emergency Response</h3>
        <p style="font-size: 14px;">Dial St. Luke's Emergency Hotline</p>
        <div class="iphone-frame">
            <div class="iphone-notch"></div>
            <div class="iphone-screen">
                <div class="calling-state" id="calling-ui">
                    <div style="font-size: 40px; margin-bottom: 10px;">üìû</div>
                    <div style="font-size: 20px; font-weight: bold;">Calling...</div>
                </div>
                <div class="iphone-display" id="phone-display"></div>
                <div class="iphone-grid">
                    <div class="iphone-key" onclick="pressKey('1')">1</div><div class="iphone-key" onclick="pressKey('2')">2</div><div class="iphone-key" onclick="pressKey('3')">3</div>
                    <div class="iphone-key" onclick="pressKey('4')">4</div><div class="iphone-key" onclick="pressKey('5')">5</div><div class="iphone-key" onclick="pressKey('6')">6</div>
                    <div class="iphone-key" onclick="pressKey('7')">7</div><div class="iphone-key" onclick="pressKey('8')">8</div><div class="iphone-key" onclick="pressKey('9')">9</div>
                    <div class="iphone-key" onclick="pressKey('*')">*</div><div class="iphone-key" onclick="pressKey('0')">0</div><div class="iphone-key" onclick="pressKey('#')">#</div>
                </div>
                <button class="iphone-call" onclick="makeCall()">üìû</button>
                <div onclick="clearPhone()" style="color:#ff3b30; font-size:11px; margin-top:10px; cursor:pointer;">DELETE</div>
            </div>
        </div>
    </div>

    <div id="grid-stage-section" class="checkpoint-box">
        <h2 id="grid-title"></h2>
        <div class="person-container">
            <div class="person-drag dr-item" id="person-logic">üö∂</div>
            <p style="font-size: 11px; font-weight: bold; color: #3b82f6; margin-top: 5px;">Drag me to Safety</p>
        </div>
        <div class="drop-grid" id="main-drop-grid"></div>
        <div id="grid-msg" style="margin-top:10px; font-weight:bold; font-size: 12px; color: red;"></div>
        <button id="gridNextBtn" class="btn btn-green" onclick="returnToGame('grid-stage-section')">CONTINUE ‚Üí</button>
    </div>

    <div id="pass-section" class="checkpoint-box">
        <h3>Stage 4: PASS Protocol</h3>
        <div style="text-align:left; line-height:2.2; font-size:14px; background:#f8fafc; padding:15px; border-radius:12px; color: black;">
            Pull the <span class="blank-inline t-trg" id="slot-PIN"></span>,<br>
            Aim the <span class="blank-inline t-trg" id="slot-NOZZLE"></span> at base,<br>
            Squeeze the <span class="blank-inline t-trg" id="slot-LEVER"></span>,<br>
            <span class="blank-inline t-trg" id="slot-SWEEP"></span> from side to side.
        </div>
        <div id="pass-bank" class="choice-grid"></div>
        <button id="passReturnBtn" class="btn btn-green" onclick="returnToGame('pass-section')">CONTINUE ‚Üí</button>
    </div>

    <div id="logic-box" class="checkpoint-box">
        <h2 id="logic-title"></h2>
        <p id="logic-desc" style="font-size: 13px;"></p>
        <div id="logic-body"></div>
        <div id="logic-msg" style="margin-top:10px; font-weight:bold; font-size: 12px;"></div>
        <button id="logicNextBtn" class="btn btn-green" onclick="returnToGame('logic-box')">CONTINUE ‚Üí</button>
    </div>

    <div id="congrats" class="checkpoint-box">
        <h1 style="color:#2563eb;">MISSION ACCOMPLISHED! üèÜ</h1>
        <p>Your unique verification code is:</p>
        <div class="code-display-box" id="codeDisplay">Fetching code...</div>
        <p style="font-size: 14px; color: #ef4444; font-weight: bold;">Step 1: Copy the code above.</p>
        <p style="font-size: 12px; color: #64748b;">Step 2: Paste the code in the form below to receive your certificate.</p>
        <button class="btn" style="background:#16a34a; color:white; margin-top:10px;" onclick="window.open('https://forms.gle/BVuivNGrSQjVwxNW9', '_blank')">GO TO CERTIFICATE FORM</button>
    </div>

<script>
/** --- CONFIG & ENGINE --- **/
let score = 0, gameActive = false, isSpraying = false, fires = [], particles = [], cp = Array(11).fill(false), stagesFinished = 0;
let gStep = 0, curLvl = 0, pc = 0;
const canvas = document.getElementById("gameCanvas"); const ctx = canvas.getContext("2d"); canvas.width = 600; canvas.height = 300;

function validate() {
    const loc = document.getElementById('user-location').value;
    const id = document.getElementById('user-id').value.trim();
    const btn = document.getElementById('form-submit-btn');
    if(loc !== "" && id !== "") { btn.style.opacity = "1"; return true; }
    btn.style.opacity = "0.5"; return false;
}
document.getElementById('user-location').onchange = validate;
document.getElementById('user-id').oninput = validate;

function saveDetails() {
    if(!validate()) { alert("Please enter Location and Player ID."); return; }
    document.getElementById('player-form-box').style.display = 'none';
    document.getElementById('start-menu').style.display = 'block';
}

function startGame() { 
    document.getElementById("start-menu").style.display="none"; 
    document.getElementById("game-section").style.display="block"; 
    document.getElementById("top-bar").style.display="flex"; 
    initUnifiedControls(); 
    gameActive=true; loop(); 
}

window.addEventListener("keydown", (e) => { if(e.code==="Space") { e.preventDefault(); isSpraying=true; } });
window.addEventListener("keyup", (e) => { if(e.code==="Space") isSpraying=false; });

function initUnifiedControls() {
    canvas.addEventListener("pointerdown", (e) => { e.preventDefault(); isSpraying = true; e.target.setPointerCapture(e.pointerId); });
    canvas.addEventListener("pointerup", () => isSpraying = false);
    let activeItem = null, shiftX, shiftY;
    document.addEventListener("pointerdown", (e) => {
        if (e.target.classList.contains("dr-item")) {
            activeItem = e.target; const rect = activeItem.getBoundingClientRect();
            shiftX = e.clientX - rect.left; shiftY = e.clientY - rect.top;
            activeItem.style.position = 'fixed'; activeItem.style.zIndex = 2000;
            activeItem.setPointerCapture(e.pointerId);
        }
    });
    document.addEventListener("pointermove", (e) => { if (activeItem) { activeItem.style.left = e.clientX - shiftX + 'px'; activeItem.style.top = e.clientY - shiftY + 'px'; } });
    document.addEventListener("pointerup", (e) => {
        if (!activeItem) return;
        activeItem.style.visibility = 'hidden'; const target = document.elementFromPoint(e.clientX, e.clientY); activeItem.style.visibility = 'visible';
        if (target && target.classList.contains("part-target") && target.dataset.answer === activeItem.innerText) { target.innerText = activeItem.innerText; target.classList.add("filled-correct"); activeItem.style.display = "none"; if (document.querySelectorAll('.checkpoint-box[style*="block"] .filled-correct').length === 6) document.getElementById("quizReturnBtn").style.display = "block"; }
        if (target && target.classList.contains("drop-zone")) handleGridDrop(activeItem, target);
        if (target && target.classList.contains("t-trg") && target.id === "slot-"+activeItem.innerText) { target.innerText = activeItem.innerText; target.style.border = "none"; activeItem.style.display = "none"; pc++; if(pc===4) document.getElementById("passReturnBtn").style.display = "block"; }
        activeItem.style.position = 'static'; activeItem = null;
    });
}

async function finishGameAndShowCode() {
    const webAppUrl = "https://script.google.com/a/macros/stlukes.com.ph/s/AKfycby1gDiL53BjYTkekxwE9G9iNSi_cRkQF-rMQf-AwgfNVi2Atc1k8PJgCHaOC90QN338/exec";
    document.getElementById("codeDisplay").innerText = "Generating code...";
    try {
        const response = await fetch(webAppUrl);
        const uniqueCodeFromSheet = await response.text();
        document.getElementById("codeDisplay").innerText = uniqueCodeFromSheet;
    } catch (error) {
        document.getElementById("codeDisplay").innerText = "Error. Please refresh.";
    }
}

function checkCheckpoint() {
    const s = score;
    if (s===10 && !cp[0]) { cp[0]=true; setupS1(); }
    else if (s===20 && !cp[1]) { cp[1]=true; showCP("phone-section"); setupS2(); }
    else if (s===30 && !cp[2]) { cp[2]=true; setupGrid(3); }
    else if (s===40 && !cp[3]) { cp[3]=true; setupS4(); }
    else if (s===50 && !cp[4]) { cp[4]=true; setupS5(); }
    else if (s===60 && !cp[5]) { cp[5]=true; setupS6(6); }
    else if (s===70 && !cp[6]) { cp[6]=true; setupS6(7); }
    else if (s===80 && !cp[7]) { cp[7]=true; setupS6(8); }
    else if (s===90 && !cp[8]) { cp[8]=true; setupGrid(9); }
    else if (s===100 && !cp[9]) { cp[9]=true; setupGrid(10); }
}

/** --- STAGE FUNCTIONS --- **/
function setupS1() { showCP("quiz-section"); document.getElementById('s1-choices').innerHTML = ["PRESSURE GAUGE","LEVER","NOZZLE","PIN","HOSE","HANDLE"].map(c => `<div class="choice-box-uniform dr-item">${c}</div>`).join(''); }
function setupS2() { document.getElementById("phone-display").innerText = ""; document.getElementById("calling-ui").style.display = "none"; }
function pressKey(n){ const d=document.getElementById("phone-display"); if(d.innerText.length<4) d.innerText+=n; }
function clearPhone(){ document.getElementById("phone-display").innerText=""; }
function makeCall(){ if(document.getElementById("phone-display").innerText==="1111"){ document.getElementById("calling-ui").style.display="flex"; setTimeout(()=>returnToGame("phone-section"), 2000); } else { clearPhone(); } }

function setupGrid(stg){
    showCP("grid-stage-section"); const grid = document.getElementById("main-drop-grid"); grid.innerHTML = "";
    document.getElementById("gridNextBtn").style.display="none"; document.getElementById("grid-msg").innerText=""; gStep = 0;
    let items = [];
    if(stg===3) {
        document.getElementById("grid-title").innerText = "Stage 3: Earthquake Logic";
        items = [{t:"üôá DUCK", c:true, s:0}, {t:"üèÉ RUN", c:false}, {t:"üè¢ LIFT", c:false}, {t:"üõ°Ô∏è COVER", c:true, s:1}, {t:"ü™ü WINDOW", c:false}, {t:"‚úä HOLD", c:true, s:2}];
    } else if(stg===9) {
        document.getElementById("grid-title").innerText = "Stage 9: Quezon City Assembly Areas";
        items = [{t:"üöó MAB Parking Area", c:true}, {t:"üè• Sta. Ignaciana St.", c:true}, {t:"‚õ™ Episcopal Church Lawn", c:true}, {t:"üçî BGC Stopover", c:false}];
    } else {
        document.getElementById("grid-title").innerText = "Stage 10: Global City Assembly Areas";
        items = [{t:"üè® Rizal Drive Lobby", c:true}, {t:"üè¢ 34th Street", c:true}, {t:"üõ£Ô∏è High Street", c:false}, {t:"üçî BGC Stopover", c:false}];
    }
    items.forEach(item => { const z = document.createElement("div"); z.className="drop-zone"; z.innerText=item.t; z.dataset.correct = item.c; if(item.s !== undefined) z.dataset.step = item.s; grid.appendChild(z); });
}

function handleGridDrop(el, trg) {
    if (trg.classList.contains("filled-correct-grid")) return;
    let isSeq = document.getElementById("grid-title").innerText.includes("Earthquake");
    if (isSeq) { if (trg.dataset.correct === "true" && parseInt(trg.dataset.step) === gStep) { trg.classList.add("filled-correct-grid"); gStep++; if(gStep === 3) document.getElementById("gridNextBtn").style.display = "block"; } else { document.getElementById("grid-msg").innerText = "Wrong Step!"; setTimeout(()=>document.getElementById("grid-msg").innerText="", 1000); }
    } else { if (trg.dataset.correct === "true") { trg.classList.add("filled-correct-grid"); trg.innerText = "‚úÖ " + trg.innerText; const trgs = document.querySelectorAll('.checkpoint-box[style*="block"] .drop-zone[data-correct="true"]'); if([...trgs].every(t=>t.classList.contains('filled-correct-grid'))) document.getElementById("gridNextBtn").style.display="block"; } }
}

function setupS4() { showCP("pass-section"); pc = 0; document.getElementById("pass-bank").innerHTML = ["PIN","NOZZLE","LEVER","SWEEP"].sort(()=>Math.random()-0.5).map(c => `<div class="choice-box-uniform dr-item">${c}</div>`).join(''); }

// STAGE 5 RACE UNIFORM LOGIC
const raceData = [
    {c:'r', o:['Run','Remove','Rescue','Rest'], a:['Rescue'], e:'üöë', t:'Rescue'},
    {c:'a', o:['Attack','Alert','Aim','Alarm'], a:['Alarm'], e:'üîî', t:'Alarm'},
    {c:'c', o:['Contain','Connect','Confine','Control'], a:['Contain', 'Confine'], e:'üö™', t:'Contain/Confine'},
    {c:'e', o:['Evacuate','Exit','Extinguish','Eat'], a:['Extinguish', 'Evacuate'], e:'üßØ', t:'Extinguish/Evacuate'}
];
let rStep = 0, selectionsInStep = [];
function setupS5() { showCP("logic-box"); document.getElementById("logic-title").innerText="Stage 5: RACE Protocol"; document.getElementById("logic-desc").innerText="Select correct actions for each letter."; rStep = 0; selectionsInStep = []; drawRace(); }
function drawRace() {
    const o = document.getElementById("logic-body"); 
    o.innerHTML=`<div id="rd" style="display:flex; justify-content:center; gap:8px; margin-bottom:15px;">
        <div class="race-letter-box" id="rr">R</div><div class="race-letter-box" id="ra">A</div>
        <div class="race-letter-box" id="rc">C</div><div class="race-letter-box" id="re">E</div>
    </div><div id="ro" class="drop-grid"></div>`;
    
    // Set already completed letters to uniform style (Emoji + Term)
    for(let i=0; i<rStep; i++){
        let box = document.getElementById("r" + raceData[i].c);
        box.classList.add('completed-box');
        box.innerHTML = `<span style="font-size:20px;">${raceData[i].e}</span><br>${raceData[i].t}`;
    }

    const container = document.getElementById("ro"); const current = raceData[rStep];
    document.getElementById("logic-msg").innerText = current.a.length > 1 ? `Pick ${current.a.length} for "${current.c.toUpperCase()}"` : `Pick for "${current.c.toUpperCase()}"`;
    current.o.forEach(opt => { 
        const b = document.createElement("div"); b.className="drop-zone"; b.style.cursor="pointer"; b.innerText = opt; 
        if (selectionsInStep.includes(opt)) b.classList.add("filled-correct-grid");
        b.onclick = () => { if (current.a.includes(opt)) { if (!selectionsInStep.includes(opt)) { selectionsInStep.push(opt); b.classList.add("filled-correct-grid"); if (selectionsInStep.length === current.a.length) { 
            rStep++; selectionsInStep = []; if (rStep === 4) { 
                let box = document.getElementById("re"); box.classList.add('completed-box'); box.innerHTML = `<span style="font-size:20px;">üßØ</span><br>Extinguish/Evacuate`;
                document.getElementById("logic-msg").innerText = "Protocol Complete! ‚úÖ"; document.getElementById("logicNextBtn").style.display = "block"; 
            } else { drawRace(); } } } } else { document.getElementById("logic-msg").innerText = "Incorrect! ‚ùå"; } }; container.appendChild(b); });
}

function setupS6(s) { curLvl = s; showCP("logic-box"); document.getElementById("logic-msg").innerText=""; document.getElementById("logicNextBtn").style.display="none"; document.getElementById("logic-title").innerText=`Stage ${s}: Emergency Codes`; let q = s===6 ? "Disaster/Hazmat?" : s===7 ? "Child Abduction?" : "Active Shooter?"; document.getElementById("logic-desc").innerText="What code for " + q; document.getElementById("logic-body").innerHTML = `<div class="rainbow-grid">` + ['Red','Orange','Yellow','Green','Blue','Pink','Silver'].map(c => { let bg = c.toLowerCase(); if(bg==='silver') bg='#717171'; if(bg==='pink') bg='#FF1493'; return `<div class="rainbow-box ri" style="background:${bg}" onclick="chkC('${c}', this)">${c}</div>`; }).join('') + `</div>`; }
function chkC(c, el) { let win = (curLvl===6 && c==='Orange') || (curLvl===7 && c==='Pink') || (curLvl===8 && c==='Silver'); if(win) { document.getElementById("logic-msg").innerText="Correct! ‚úÖ"; document.getElementById("logicNextBtn").style.display="block"; document.querySelectorAll('.ri').forEach(box => box.classList.add('locked')); el.classList.add('selected-correct'); } else { document.getElementById("logic-msg").innerText="Wrong code! ‚ùå"; } }

function showCP(id) { gameActive=false; document.getElementById("game-section").style.display="none"; document.getElementById(id).style.display="block"; }
function returnToGame(id) { stagesFinished++; document.getElementById("p-bar-main").style.width=(stagesFinished/10*100)+"%"; if(stagesFinished===10){ document.getElementById(id).style.display="none"; finishGameAndShowCode(); document.getElementById("congrats").style.display="block"; return; } document.getElementById(id).style.display="none"; document.getElementById("game-section").style.display="block"; fires=[]; gameActive=true; loop(); }

function update() {
    if (!gameActive) return;
    if (isSpraying) for(let i=0;i<5;i++) particles.push({x:90,y:220,vx:6+Math.random()*3,vy:(Math.random()-0.5)*3,life:20,size:4+Math.random()*6});
    for(let i=particles.length-1;i>=0;i--){particles[i].x+=particles[i].vx; particles[i].y+=particles[i].vy; if(--particles[i].life<=0)particles.splice(i,1);}
    if(Math.random()<0.02) fires.push({x:600,y:230}); 
    for(let i=fires.length-1;i>=0;i--){ 
        fires[i].x -= 1.8; 
        particles.forEach(p=>{ if(fires[i]&&p.x>fires[i].x && p.x<fires[i].x+40){ fires.splice(i,1); score++; document.getElementById("score").innerText="Score: "+score; checkCheckpoint(); } });
        if(fires[i] && fires[i].x < 90) { fires.splice(i,1); if(score > 0) score--; document.getElementById("score").innerText="Score: "+score; }
    }
}
function draw(){ ctx.clearRect(0,0,600,300); ctx.fillStyle="#1e293b"; ctx.fillRect(0,270,600,30); ctx.fillStyle="#ffffff"; particles.forEach(p=>{ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill();}); ctx.fillStyle="#ef4444"; ctx.fillRect(50,200,40,60); ctx.font="35px Arial"; fires.forEach(f=>ctx.fillText("üî•",f.x,f.y+30)); }
function loop(){ if(gameActive){update(); draw(); requestAnimationFrame(loop);} }
</script>
</body>
</html>
