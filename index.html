<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BEPADCT: Blaze Buster Minigame</title>
    <style>
        body { margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background-color: #0f172a; font-family: 'Segoe UI', sans-serif; color: #f7fafc; overflow-x: hidden; user-select: none; touch-action: none; }
        
        /* Initial Screen & Form Styles */
        #pre-game-box, #player-form-box { text-align: center; background: #1e293b; padding: 40px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.5); width: 85%; max-width: 400px; z-index: 100; }
        #player-form-box { text-align: left; display: none; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 12px; color: #60a5fa; margin-bottom: 5px; font-weight: bold; }
        .form-group select, .form-group input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box; }
        
        .main-controls { width: 95%; max-width: 600px; margin-bottom: 10px; display: none; gap: 10px; align-items: center; background: #1e293b; padding: 10px; border-radius: 12px; box-sizing: border-box; justify-content: space-between; }
        #score-text { font-size: 18px; font-weight: bold; color: #60a5fa; }
        
        #game-section { display: none; text-align: center; width: 100%; max-width: 600px; position: relative; }
        canvas { width: 95%; height: auto; border: 3px solid #334155; background-color: #020617; border-radius: 12px; cursor: crosshair; }
        
        .progress-container { width: 90%; height: 10px; background: #334155; border-radius: 10px; margin: 10px auto; overflow: hidden; }
        .progress-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #60a5fa, #3b82f6); transition: width 0.5s ease; }
        
        /* Buster Animation Styles */
        .buster-intro-container { text-align: center; perspective: 1000px; padding: 20px; }
        .buster-character { font-size: 80px; display: inline-block; animation: buster-bounce 2s infinite ease-in-out; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.3)); }
        @keyframes buster-bounce {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-20px) rotate(-5deg); }
            75% { transform: translateY(-10px) rotate(5deg); }
        }
        .speech-bubble { background: #ffffff; color: #1e293b; padding: 20px; border-radius: 15px; margin: 20px auto; max-width: 300px; position: relative; font-weight: bold; box-shadow: 0 10px 20px rgba(0,0,0,0.2); opacity: 0; transform: scale(0.8); transition: all 0.5s ease; }
        .speech-bubble.active { opacity: 1; transform: scale(1); }
        .speech-bubble:after { content: ''; position: absolute; bottom: -15px; left: 50%; border-width: 15px 15px 0; border-style: solid; border-color: #ffffff transparent; display: block; width: 0; margin-left: -15px; }

        /* Checkpoint & Quiz Styles */
        .checkpoint-box { display: none; background: white; padding: 20px 30px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.6); text-align: center; width: 90%; max-width: 850px; color: #1e293b; max-height: 90vh; overflow-y: auto; box-sizing: border-box; z-index: 1000; }
        .diagram-wrapper { position: relative; width: 300px; height: 350px; background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSpPUDif2LkKX4bx3_sXJquY6_nF20kS_56aw&s'); background-size: contain; background-repeat: no-repeat; background-position: center; margin: 0 auto; }
        .part-target { position: absolute; border: 2px solid #3b82f6; background: rgba(59, 130, 246, 0.1); border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; font-size: 6px; font-weight: bold; text-align: center; line-height: 1; pointer-events: auto; }
        .part-target.filled-correct { background: #1e3a8a !important; color: white !important; border-color: #1e40af; pointer-events: none; }
        
        .choice-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; justify-items: center; }
        .choice-box-uniform { width: 130px; padding: 12px 0; background: #2563eb; color: white; border-radius: 6px; cursor: pointer; font-weight: bold; text-align: center; font-size: 11px; touch-action: none; position: relative; }
        
        /* Stage Specifics */
        .iphone-frame { width: 220px; height: 430px; background: #1c1c1e; border-radius: 40px; border: 8px solid #334155; margin: 0 auto; position: relative; padding: 10px; }
        .iphone-screen { background: #000; height: 100%; border-radius: 30px; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .iphone-display { color: #fff; font-size: 24px; height: 40px; margin-bottom: 20px; letter-spacing: 2px; text-align: center; width: 100%; }
        .iphone-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .iphone-key { width: 50px; height: 50px; background: #3a3a3c; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; }
        .iphone-call { width: 55px; height: 55px; background: #34c759; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 26px; border: none; margin-top: 15px; cursor: pointer; }
        .calling-state { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #34c759; color: white; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 20; }
        
        .person-container { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
        .person-drag { font-size: 55px; cursor: grab; background: white; border-radius: 50%; border: 4px solid #3b82f6; width: 75px; height: 75px; display: flex; align-items: center; justify-content: center; touch-action: none; position: relative; z-index: 5; }
        .drop-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; }
        .drop-zone { border: 2px dashed #94a3b8; border-radius: 12px; padding: 10px; display: flex; align-items: center; justify-content: center; background: #f1f5f9; min-height: 65px; font-size: 11px; font-weight: bold; color: #475569; }
        .filled-correct-grid { background: #dcfce7 !important; border: 2px solid #16a34a !important; color: #166534 !important; }
        
        .rainbow-grid { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 15px; }
        .rainbow-box { width: 70px; height: 90px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: white; text-transform: uppercase; border: 3px solid transparent; transition: 0.2s; }
        .locked { pointer-events: none !important; opacity: 0.4; filter: grayscale(0.5); }
        .selected-correct { border: 4px solid #16a34a !important; opacity: 1 !important; filter: none !important; transform: scale(1.1); box-shadow: 0 0 15px rgba(22, 163, 74, 0.5); }
        
        .race-letter-box { width: 95px; height: 95px; background: #f1f5f9; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 10px; color: #1e293b; border: 2px solid #cbd5e1; text-align: center; padding: 4px; line-height: 1.2; }
        .btn { padding: 12px 30px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.3s; }
        .btn:hover { transform: scale(1.05); }
        .btn-green { background: #16a34a; color: white; display: none; margin: 15px auto 0; }
        .btn-small { padding: 8px 12px; border-radius: 6px; font-size: 10px; font-weight: bold; cursor: pointer; border: none; }
        .blank-inline { display: inline-flex; width: 100px; height: 30px; border-bottom: 3px solid #3b82f6; margin: 0 5px; vertical-align: middle; justify-content: center; align-items: center; font-weight: bold; color: #1e40af; }
    </style>
</head>
<body>

    <div id="pre-game-box">
        <h1 style="color: #60a5fa; margin-bottom: 30px;">BEPADCT: Blaze Buster Minigame</h1>
        <button class="btn" style="background:#3b82f6; color:white; font-size: 24px; padding: 20px 60px;" onclick="showForm()">PLAY</button>
    </div>

    <div id="player-form-box">
        <h2 style="color: #60a5fa; margin-top:0; text-align: center;">PLAYER DETAILS</h2>
        <div class="form-group">
            <label>I AM FROM ST. LUKE'S MEDICAL CENTER</label>
            <select id="user-location" onchange="validate()">
                <option value="" disabled selected>Select Location</option>
                <option value="GLOBAL CITY">GLOBAL CITY</option>
                <option value="QUEZON CITY">QUEZON CITY</option>
                <option value="EXTENSION CLINIC">EXTENSION CLINIC</option>
                <option value="COLLEGE OF MEDICINE">COLLEGE OF MEDICINE</option>
            </select>
        </div>
        <div class="form-group">
            <label>I AM PLAYER NUMBER</label>
            <input type="text" id="user-id" placeholder="Enter employee no. / doctor's code / student no." oninput="validate(); this.value = this.value.replace(/[^0-9]/g, '');">
        </div>
        <button class="btn" id="form-submit-btn" style="background:#3b82f6; color:white; width:100%; opacity: 0.5;" onclick="saveDetails()">PROCEED</button>
    </div>

    <div id="start-menu" style="display:none; text-align: center;">
        <div class="buster-intro-container">
            <div class="buster-character">üßØ</div>
            <div id="buster-bubble" class="speech-bubble">
                Halt! I'm Buster, your Fire Safety Partner!
            </div>
            <div id="story-text" style="margin-bottom: 20px; color: #94a3b8; font-style: italic; min-height: 40px;">
                Emergency alarms are sounding across the hospital...
            </div>
            <button class="btn" id="story-btn" style="background:#3b82f6; color:white;" onclick="nextStoryStep()">NEXT</button>
            <button class="btn" id="start-mission-btn" style="background:#16a34a; color:white; display:none;" onclick="startGame()">IGNITE MISSION!</button>
        </div>
    </div>

    <div class="main-controls" id="top-bar">
        <div class="hud-left">
            <button class="btn-small" style="background:#f59e0b; color:white;" onclick="togglePause()" id="pause-btn">PAUSE</button>
            <button class="btn-small" style="background:#ef4444; color:white;" onclick="location.reload()">EMERGENCY RESET</button>
        </div>
        <div class="hud-right">
            <div id="score-text">Score: 0</div>
            <div id="player-hud-id" style="font-size: 10px; color: #94a3b8;"></div>
        </div>
    </div>

    <div id="game-section">
        <canvas id="gameCanvas"></canvas>
        <div class="progress-container"><div class="progress-fill" id="p-bar-main"></div></div>
        <p style="color: #94a3b8; font-size: 12px; text-align: center;"><b>Move mouse/touch to aim and tap to spray</b></p>
    </div>

    <div id="quiz-section" class="checkpoint-box">
        <h3>Stage 1: Equipment Check</h3>
        <p style="font-size: 14px;">Drag and drop parts to the fire extinguisher.</p>
        <div class="diagram-wrapper">
            <div class="part-target" data-answer="HANDLE" style="top:32px; left:158px;"></div>
            <div class="part-target" data-answer="LEVER" style="top:72px; left:168px;"></div>
            <div class="part-target" data-answer="PIN" style="top:40px; left:133px;"></div>
            <div class="part-target" data-answer="PRESSURE GAUGE" style="top:65px; left:128px;"></div> 
            <div class="part-target" data-answer="HOSE" style="top:130px; left:70px;"></div>
            <div class="part-target" data-answer="NOZZLE" style="top:240px; left:90px;"></div>
        </div>
        <div class="choice-grid" id="s1-choices"></div>
        <button id="quizReturnBtn" class="btn btn-green" onclick="returnToGame('quiz-section')">CONTINUE ‚Üí</button>
    </div>

    <div id="phone-section" class="checkpoint-box">
        <h3>Stage 2: Emergency Response</h3>
        <p style="font-size: 14px;">Dial the St. Luke's Emergency Hotline</p>
        <div class="iphone-frame">
            <div class="iphone-screen">
                <div class="calling-state" id="calling-ui">
                    <div style="font-size: 40px; margin-bottom: 10px;">üìû</div>
                    <div>Calling...</div>
                </div>
                <div class="iphone-display" id="phone-display"></div>
                <div class="iphone-grid">
                    <div class="iphone-key" onclick="pressKey('1')">1</div><div class="iphone-key" onclick="pressKey('2')">2</div><div class="iphone-key" onclick="pressKey('3')">3</div>
                    <div class="iphone-key" onclick="pressKey('4')">4</div><div class="iphone-key" onclick="pressKey('5')">5</div><div class="iphone-key" onclick="pressKey('6')">6</div>
                    <div class="iphone-key" onclick="pressKey('7')">7</div><div class="iphone-key" onclick="pressKey('8')">8</div><div class="iphone-key" onclick="pressKey('9')">9</div>
                    <div class="iphone-key" onclick="pressKey('*')">*</div><div class="iphone-key" onclick="pressKey('0')">0</div><div class="iphone-key" onclick="pressKey('#')">#</div>
                </div>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <button class="iphone-call" onclick="makeCall()">üìû</button>
                    <div onclick="clearPhone()" style="color:#ff3b30; font-weight:bold; cursor:pointer; margin-top:15px; font-size:12px;">DELETE</div>
                </div>
            </div>
        </div>
    </div>

    <div id="grid-stage-section" class="checkpoint-box">
        <h2 id="grid-title" style="text-align: center;"></h2>
        <p id="grid-instr" style="font-size: 14px; margin-bottom: 10px;"></p>
        <div class="person-container">
            <div class="person-drag dr-item" id="person-logic">üö∂</div>
            <p style="font-size: 12px; color: #3b82f6; font-weight: bold; margin-top: 5px;">Drag me to safety!</p>
        </div>
        <div class="drop-grid" id="main-drop-grid"></div>
        <div id="grid-msg" style="margin-top:10px; font-weight:bold; color: red;"></div>
        <button id="gridNextBtn" class="btn btn-green" onclick="returnToGame('grid-stage-section')">CONTINUE ‚Üí</button>
    </div>

    <div id="pass-section" class="checkpoint-box">
        <h3>Stage 4: PASS Protocol</h3>
        <p style="font-size: 14px;">Complete the extinguisher protocol.</p>
        <div style="text-align:left; line-height:2.2; font-size:14px; background:#f8fafc; padding:15px; border-radius:12px; color: black;">
            Pull the <span class="blank-inline t-trg" id="slot-PIN"></span>,<br>
            Aim the <span class="blank-inline t-trg" id="slot-NOZZLE"></span> at base,<br>
            Squeeze the <span class="blank-inline t-trg" id="slot-LEVER"></span>,<br>
            <span class="blank-inline t-trg" id="slot-SWEEP"></span> from side to side.
        </div>
        <div id="pass-bank" class="choice-grid"></div>
        <button id="passReturnBtn" class="btn btn-green" onclick="returnToGame('pass-section')">CONTINUE ‚Üí</button>
    </div>

    <div id="logic-box" class="checkpoint-box">
        <h2 id="logic-title" style="text-align: center;"></h2>
        <p id="logic-desc" style="font-size: 13px;"></p>
        <div id="logic-body"></div>
        <div id="logic-msg" style="margin-top:10px; font-weight:bold;"></div>
        <button id="logicNextBtn" class="btn btn-green" onclick="returnToGame('logic-box')">CONTINUE ‚Üí</button>
    </div>

    <div id="congrats" class="checkpoint-box">
        <h1 style="color:#2563eb; text-align: center;">MISSION ACCOMPLISHED! üèÜ</h1>
        <div style="text-align: left; font-size: 14px; padding: 10px; background: #f8fafc; border-radius: 10px; border-left: 4px solid #3b82f6; margin-bottom: 15px;">
            <p><b>Steps to claim your certificate:</b></p>
            <ol>
                <li>Click <b>REVEAL MY CODE</b>. A new tab will open in your browser.</li>
                <li><b>Copy</b> the unique verification code displayed in that tab.</li>
                <li>Complete the form and <b>Paste</b> the code in the required field to verify your mission completion.</li>
            </ol>
        </div>
        <button class="btn" id="reveal-btn" style="background:#3b82f6; color:white; width:100%;" onclick="revealCodeRedirect()">REVEAL MY CODE</button>
    </div>

<script>
let score = 0, gameActive = false, isSpraying = false, fires = [], particles = [], cp = Array(11).fill(false), stagesFinished = 0, isPaused = false;
let gStep = 0, rStep = 0, rSel = [], pc = 0, playerID = "", extY = 150;
const canvas = document.getElementById("gameCanvas"); const ctx = canvas.getContext("2d"); canvas.width = 600; canvas.height = 300;

// STORY VARIABLES
let storyIndex = 0;
const storySteps = [
    { bubble: "Wait! You're the new safety recruit, right?", narrative: "Buster looks you up and down with his pressure gauge eye." },
    { bubble: "The hospital is under a 'Blaze Alert'. Small fires are popping up!", narrative: "You hear the distant sound of Code Orange alarms." },
    { bubble: "I've got the foam, but I need your hands to aim. Teamwork saves lives!", narrative: "Buster shakes with excitement (and high-pressure gas)." },
    { bubble: "To stop the spread, we need 100 points. Are you ready?", narrative: "The mission is clear: Protect St. Luke's at all costs." }
];

function showForm() {
    document.getElementById('pre-game-box').style.display = 'none';
    document.getElementById('player-form-box').style.display = 'block';
}

function validate() {
    const loc = document.getElementById('user-location').value;
    const idInput = document.getElementById('user-id');
    const btn = document.getElementById('form-submit-btn');
    if(loc !== "" && idInput.value.trim() !== "") { btn.style.opacity = "1"; return true; }
    btn.style.opacity = "0.5"; return false;
}

function saveDetails() {
    if(!validate()) return;
    playerID = document.getElementById('user-id').value;
    document.getElementById('player-form-box').style.display = 'none';
    document.getElementById('start-menu').style.display = 'block';
    document.getElementById('player-hud-id').innerText = `ID: ${playerID}`;
    
    setTimeout(() => {
        document.getElementById('buster-bubble').classList.add('active');
    }, 500);
}

function nextStoryStep() {
    if (storyIndex < storySteps.length) {
        const bubble = document.getElementById('buster-bubble');
        const narrative = document.getElementById('story-text');
        bubble.classList.remove('active');
        
        setTimeout(() => {
            bubble.innerText = storySteps[storyIndex].bubble;
            narrative.innerText = storySteps[storyIndex].narrative;
            bubble.classList.add('active');
            storyIndex++;
            if (storyIndex === storySteps.length) {
                document.getElementById('story-btn').style.display = 'none';
                document.getElementById('start-mission-btn').style.display = 'inline-block';
            }
        }, 300);
    }
}

function startGame() { 
    document.getElementById("start-menu").style.display="none"; 
    document.getElementById("game-section").style.display="block"; 
    document.getElementById("top-bar").style.display="flex"; 
    initUnifiedControls(); gameActive=true; loop(); 
}

function togglePause() { isPaused = !isPaused; document.getElementById('pause-btn').innerText = isPaused ? "RESUME" : "PAUSE"; if(!isPaused) loop(); }

function initUnifiedControls() {
    canvas.addEventListener("pointerdown", (e) => { if(!isPaused) isSpraying = true; });
    canvas.addEventListener("pointerup", () => isSpraying = false);
    canvas.addEventListener("pointermove", (e) => {
        const rect = canvas.getBoundingClientRect();
        const scaleY = canvas.height / rect.height;
        extY = (e.clientY - rect.top) * scaleY - 30;
    });

    let activeItem = null, shiftX, shiftY;
    document.addEventListener("pointerdown", (e) => {
        if (e.target.classList.contains("dr-item")) {
            activeItem = e.target; const rect = activeItem.getBoundingClientRect();
            shiftX = e.clientX - rect.left; shiftY = e.clientY - rect.top;
            activeItem.style.position = 'fixed'; activeItem.style.zIndex = 2000;
            activeItem.setPointerCapture(e.pointerId);
        }
    });
    document.addEventListener("pointermove", (e) => { if (activeItem) { activeItem.style.left = e.clientX - shiftX + 'px'; activeItem.style.top = e.clientY - shiftY + 'px'; } });
    document.addEventListener("pointerup", (e) => {
        if (!activeItem) return;
        activeItem.style.visibility = 'hidden'; const target = document.elementFromPoint(e.clientX, e.clientY); activeItem.style.visibility = 'visible';
        if (target && target.classList.contains("part-target") && target.dataset.answer === activeItem.innerText) { target.innerText = activeItem.innerText; target.classList.add("filled-correct"); activeItem.style.display = "none"; if (document.querySelectorAll('.checkpoint-box[style*="block"] .filled-correct').length === 6) document.getElementById("quizReturnBtn").style.display = "block"; }
        if (target && target.classList.contains("drop-zone")) handleGridDrop(activeItem, target);
        if (target && target.classList.contains("t-trg") && target.id === "slot-"+activeItem.innerText) { target.innerText = activeItem.innerText; target.style.border = "none"; activeItem.style.display = "none"; pc++; if(pc===4) document.getElementById("passReturnBtn").style.display = "block"; }
        activeItem.style.position = 'static'; activeItem = null;
    });
}

function checkCheckpoint() {
    if (score === 10 && !cp[0]) { cp[0]=true; setupS1(); }
    else if (score === 20 && !cp[1]) { cp[1]=true; showCP("phone-section"); setupS2(); }
    else if (score === 30 && !cp[2]) { cp[2]=true; setupGrid(3); }
    else if (score === 40 && !cp[3]) { cp[3]=true; setupS4(); }
    else if (score === 50 && !cp[4]) { cp[4]=true; setupS5(); }
    else if (score === 60 && !cp[5]) { cp[5]=true; setupS6(6); }
    else if (score === 70 && !cp[6]) { cp[6]=true; setupS6(7); }
    else if (score === 80 && !cp[7]) { cp[7]=true; setupS6(8); }
    else if (score === 90 && !cp[8]) { cp[8]=true; setupGrid(9); }
    else if (score === 100 && !cp[9]) { cp[9]=true; setupGrid(10); }
}

function setupS1() { showCP("quiz-section"); document.getElementById('s1-choices').innerHTML = ["PRESSURE GAUGE","LEVER","NOZZLE","PIN","HOSE","HANDLE"].map(c => `<div class="choice-box-uniform dr-item">${c}</div>`).join(''); }
function setupS2() { document.getElementById("phone-display").innerText = ""; document.getElementById("calling-ui").style.display = "none"; }
function pressKey(n){ const d=document.getElementById("phone-display"); if(d.innerText.length<4) d.innerText+=n; }
function clearPhone(){ document.getElementById("phone-display").innerText = ""; }
function makeCall(){ 
    const d = document.getElementById("phone-display");
    if(d.innerText==="1111"){ 
        document.getElementById("calling-ui").style.display="flex"; 
        setTimeout(()=>returnToGame("phone-section"), 1500); 
    } else { 
        d.innerText = "Wrong Number!";
        setTimeout(() => d.innerText = "", 1000);
    } 
}

function setupGrid(stg){
    showCP("grid-stage-section"); const grid = document.getElementById("main-drop-grid"); grid.innerHTML = "";
    document.getElementById("gridNextBtn").style.display="none"; gStep = 0;
    let items = [];
    if(stg===3) { 
        document.getElementById("grid-title").innerText="Stage 3: Earthquake Protocol"; 
        document.getElementById("grid-instr").innerText="Drag the person to the safety actions in order.";
        items=[{t:"üôá DUCK",c:true,s:0},{t:"üõ°Ô∏è COVER",c:true,s:1},{t:"‚úä HOLD",c:true,s:2},{t:"üèÉ RUN",c:false},{t:"üè¢ LIFT",c:false},{t:"ü™ü WINDOW",c:false}]; 
    }
    else if(stg===9) { 
        document.getElementById("grid-title").innerText="Stage 9: Quezon City Assembly"; 
        document.getElementById("grid-instr").innerText="Identify the correct assembly areas.";
        items=[{t:"üöó MAB Parking Area",c:true},{t:"üè¢ Street fronting multi-level parking",c:true},{t:"üè• Sta. Ignaciana fronting SS entrance/exit",c:true},{t:"üè´ Sta. Ignaciana Street fronting COM",c:true},{t:"‚õ™ Episcopal Church and lawn",c:true},{t:"üõ£Ô∏è High Street",c:false}]; 
    }
    else { 
        document.getElementById("grid-title").innerText="Stage 10: Global City Assembly"; 
        document.getElementById("grid-instr").innerText="Identify the correct assembly areas.";
        items=[{t:"üè® Rizal Drive across Main Lobby",c:true},{t:"üè¢ 34th Street",c:true},{t:"üõ£Ô∏è High Street",c:false},{t:"‚õ™ Episcopal Church Lawn",c:false},{t:"üöó MAB Parking Area",c:false},{t:"üçî BGC Stopover",c:false}]; 
    }
    items.sort(()=>Math.random()-0.5).forEach(i => { let z=document.createElement("div"); z.className="drop-zone"; z.innerText=i.t; z.dataset.correct=i.c; if(i.s!==undefined)z.dataset.step=i.s; grid.appendChild(z); });
}

function handleGridDrop(el, trg) {
    if (trg.dataset.correct === "true") { 
        if(trg.dataset.step !== undefined && parseInt(trg.dataset.step) !== gStep) return;
        trg.classList.add("filled-correct-grid"); gStep++; 
        if(document.querySelectorAll('.checkpoint-box[style*="block"] .drop-zone[data-correct="true"]').length === gStep) document.getElementById("gridNextBtn").style.display="block"; 
    }
}

function setupS4() { showCP("pass-section"); pc=0; document.getElementById("pass-bank").innerHTML=["PIN","NOZZLE","LEVER","SWEEP"].sort(()=>Math.random()-0.5).map(c=>`<div class="choice-box-uniform dr-item">${c}</div>`).join(''); }

function setupS5() { 
    showCP("logic-box"); document.getElementById("logic-title").innerText="Stage 5: RACE Protocol"; 
    rStep=0; rSel=[]; drawRace(); 
}

function drawRace() {
    const raceData = [
        {l:'R', t:'Rescue üöë', a:['Rescue üöë'], opts: ['Rescue üöë', 'Run üèÉ', 'Remove üóëÔ∏è', 'Rest üí§']},
        {l:'A', t:'Alarm üîî', a:['Alarm üîî'], opts: ['Alarm üîî', 'Attack üëä', 'Alert üö®', 'Aim üéØ']},
        {l:'C', t:'Contain/Confine üõ°Ô∏è', a:['Contain üõ°Ô∏è', 'Confine üîí'], opts: ['Contain üõ°Ô∏è', 'Confine üîí', 'Connect üîó', 'Cover üôä']},
        {l:'E', t:'Extinguish/Evacuate üèÉ', a:['Extinguish üßØ', 'Evacuate üèÉ'], opts: ['Extinguish üßØ', 'Evacuate üèÉ', 'Eat üçé', 'Exit üö™']}
    ];
    const o=document.getElementById("logic-body"); 
    o.innerHTML=`<div style="display:flex; justify-content:center; gap:10px; margin-bottom:20px;">`+raceData.map(r=>`<div class="race-letter-box" id="r${r.l}">${r.l}</div>`).join('')+`</div><div id="ro" class="drop-grid"></div>`;
    
    for(let i=0; i<rStep; i++){ let b=document.getElementById("r"+raceData[i].l); b.style.backgroundColor="#dcfce7"; b.innerText=raceData[i].t; }
    if(rStep===4){ document.getElementById("logicNextBtn").style.display="block"; document.getElementById("logic-msg").innerText="Correct! ‚úÖ"; return; }
    
    const current = raceData[rStep];
    document.getElementById("logic-msg").innerText = `Pick answer(s) for "${current.l}" (${current.a.length})`;
    current.opts.sort(()=>Math.random()-0.5).forEach(opt => {
        let b = document.createElement("div"); b.className = "drop-zone"; b.style.cursor = "pointer"; b.innerText = opt;
        if(rSel.includes(opt)) b.classList.add('filled-correct-grid');
        b.onclick = () => {
            if(current.a.includes(opt)) {
                if(!rSel.includes(opt)) { rSel.push(opt); b.classList.add('filled-correct-grid'); if(rSel.length === current.a.length) { rStep++; rSel=[]; drawRace(); } }
            }
        };
        document.getElementById("ro").appendChild(b);
    });
}

function setupS6(s) { 
    showCP("logic-box"); document.getElementById("logicNextBtn").style.display="none"; 
    document.getElementById("logic-msg").innerText="";
    let title="", q="", winC="", colors=['Red','Orange','Yellow','Green','Blue','Pink','Silver'];
    if(s===6){title="Stage 6: Code Activation";q="What Code do you activate in case of Fire, Chemical Spill, Radiation or Gas Leak, Earthquake, Flood?";winC="Orange";}
    if(s===7){title="Stage 7: Code Activation";q="What code do you activate for Child Abduction?";winC="Pink";}
    if(s===8){title="Stage 8: Code Activation";q="What code do you activate for an Active Shooter?";winC="Silver";}
    document.getElementById("logic-title").innerText=title; document.getElementById("logic-desc").innerText=q; 
    document.getElementById("logic-body").innerHTML=`<div class="rainbow-grid">`+colors.map(c=>{
        let bg=c.toLowerCase(); if(bg==='silver')bg='#717171'; if(bg==='pink')bg='#FF1493';
        return `<div class="rainbow-box ri" style="background:${bg}" onclick="chkC('${c}', '${winC}', this)">${c}</div>`;
    }).join('')+`</div>`;
}

function chkC(c, winC, el) {
    if(c === winC) {
        el.classList.add('selected-correct'); 
        document.getElementById('logicNextBtn').style.display='block';
        document.getElementById("logic-msg").innerText="Correct! ‚úÖ";
        document.querySelectorAll('.ri').forEach(box => { if(box !== el) box.classList.add('locked'); });
    }
}

function showCP(id) { gameActive=false; document.getElementById("game-section").style.display="none"; document.getElementById(id).style.display="block"; }
function returnToGame(id) { 
    stagesFinished++; document.getElementById("p-bar-main").style.width=(stagesFinished/10*100)+"%"; 
    if(stagesFinished===10){document.getElementById(id).style.display="none";document.getElementById("congrats").style.display="block";return;} 
    document.getElementById(id).style.display="none"; document.getElementById("game-section").style.display="block"; fires=[]; gameActive=true; loop(); 
}

function update() {
    if (!gameActive || isPaused) return;
    if (isSpraying) for(let i=0;i<5;i++) particles.push({x:90,y:extY+25,vx:7,vy:(Math.random()-0.5)*4,life:25,size:5});
    for(let i=particles.length-1;i>=0;i--){particles[i].x+=particles[i].vx; particles[i].y+=particles[i].vy; if(--particles[i].life<=0)particles.splice(i,1);}
    if(Math.random()<0.03) fires.push({x:600,y:100+Math.random()*150}); 
    for(let i=fires.length-1;i>=0;i--){ 
        fires[i].x -= 2; 
        particles.forEach(p=>{ if(fires[i]&&p.x>fires[i].x && Math.abs(p.y-(fires[i].y+20))<45){ fires.splice(i,1); score++; document.getElementById("score-text").innerText="Score: "+score; checkCheckpoint(); } });
        if(fires[i] && fires[i].x < 50) { fires.splice(i,1); if(score > 0) score--; document.getElementById("score-text").innerText="Score: "+score; }
    }
}
function draw(){ 
    ctx.clearRect(0,0,600,300); ctx.fillStyle="#1e293b"; ctx.fillRect(0,280,600,20);
    ctx.fillStyle="#e2e8f0"; particles.forEach(p=>{ctx.beginPath();ctx.arc(p.x,p.y,p.size,0,Math.PI*2);ctx.fill();});
    ctx.fillStyle="#ef4444"; ctx.fillRect(50,extY,35,60); ctx.fillStyle="#334155"; ctx.fillRect(45,extY,45,10);
    ctx.font="35px Arial"; fires.forEach(f=>ctx.fillText("üî•",f.x,f.y+30)); 
}
function loop(){ if(gameActive && !isPaused){update(); draw(); requestAnimationFrame(loop);} }

function revealCodeRedirect() {
    window.open("https://script.google.com/a/macros/stlukes.com.ph/s/AKfycbzcqiGztCFof_d6KkI0lKw8UTtFfJZ0RSVFI8WbiuCGtbXYXeCv9hqtipcvAhQPpV3O/exec", "_blank");
}
</script>
</body>
</html>
