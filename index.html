<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Safety Training Mission: 10 Stages</title>
    <style>
        body { margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background-color: #0f172a; font-family: 'Segoe UI', sans-serif; color: #f7fafc; overflow-x: hidden; touch-action: manipulation; }
        
        /* Mobile Responsive Header */
        .main-controls { width: 90%; max-width: 600px; margin-bottom: 10px; display: flex; gap: 10px; align-items: center; background: #1e293b; padding: 10px; border-radius: 12px; box-sizing: border-box; }
        #score { font-size: 20px; font-weight: bold; color: #60a5fa; flex-grow: 1; }

        /* Login & Start Menu - Mobile Sized */
        .login-card { background: #1e293b; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center; width: 85%; max-width: 320px; border: 1px solid #334155; }
        .input-group input { width: 100%; padding: 15px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; font-size: 16px; box-sizing: border-box; }
        
        /* Canvas Responsive Scaling */
        #game-section { display: none; text-align: center; width: 100%; max-width: 600px; position: relative; }
        canvas { width: 95%; height: auto; border: 3px solid #334155; background-color: #020617; border-radius: 12px; }

        .progress-container { width: 90%; height: 8px; background: #334155; border-radius: 10px; margin: 10px auto; overflow: hidden; }
        .progress-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #60a5fa, #3b82f6); transition: width 0.5s ease; }

        /* Checkpoint Box - Mobile Height Limit */
        .checkpoint-box { display: none; background: white; padding: 15px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.6); text-align: center; width: 90%; max-width: 450px; color: #1e293b; max-height: 85vh; overflow-y: auto; }

        /* STAGE 1: MOBILE SCALING */
        .diagram-wrapper { position: relative; width: 280px; height: 340px; background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSpPUDif2LkKX4bx3_sXJquY6_nF20kS_56aw&s'); background-size: contain; background-repeat: no-repeat; background-position: center; margin: 0 auto; }
        .part-target { position: absolute; border: 2px solid #3b82f6; background: rgba(59, 130, 246, 0.1); border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 6px; font-weight: bold; overflow: hidden; }
        .part-target.filled-correct { background: #1e3a8a !important; color: white !important; border-color: #1e40af; font-size: 5px; }
        
        .choice-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 10px; }
        .choice-box-uniform { padding: 10px 5px; background: #2563eb; color: white; border-radius: 6px; cursor: pointer; font-weight: bold; text-align: center; font-size: 11px; touch-action: none; }

        /* IPHONE STAGE 2 - SCALED FOR MOBILE */
        .iphone-frame { width: 200px; height: 400px; background: #000; border-radius: 35px; border: 6px solid #334155; margin: 0 auto; position: relative; padding: 10px; }
        .iphone-notch { width: 80px; height: 15px; background: #334155; position: absolute; top: 0; left: 50%; transform: translateX(-50%); border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; }
        .iphone-display { color: #fff; font-size: 24px; height: 35px; margin-bottom: 10px; }
        .iphone-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .iphone-key { width: 45px; height: 45px; background: #1c1c1e; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .iphone-call { width: 50px; height: 50px; background: #34c759; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; border: none; margin-top: 10px; }

        /* RAINBOW BOXES FOR TOUCH */
        .rainbow-box { width: 45px; height: 60px; border-radius: 8px; font-size: 7px; }

        .btn { padding: 15px 25px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 16px; }
        .btn-green { background: #16a34a; color: white; display: none; margin: 15px auto 0; }
        
        #fail-overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); color: #ef4444; flex-direction: column; align-items: center; justify-content: center; z-index: 100; border-radius: 12px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h2 style="color: #60a5fa; margin-top:0;">Safety Mission</h2>
            <div class="input-group">
                <label>Employee No:</label>
                <input type="number" id="emp-id-input" placeholder="ID (e.g. 1001)">
            </div>
            <div id="search-result" style="margin-bottom: 15px; padding: 10px; border-radius: 8px; background: rgba(59, 130, 246, 0.1); color: #60a5fa; display: none; font-weight: bold; font-size: 14px;">
                Welcome, <span id="player-name-span"></span>!
            </div>
            <button id="search-btn" onclick="searchEmployee()" style="width: 100%; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-weight: bold;">SEARCH NAME</button>
            <button id="start-mission-btn" onclick="initGame()" style="width: 100%; padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: bold; display: none; margin-top:10px;">START MISSION</button>
            <p id="error-msg" style="color: #ef4444; font-size: 12px; margin-top: 10px; display: none;">ID not found.</p>
        </div>
    </div>

    <div class="main-controls" id="top-bar" style="display: none;">
        <div id="score">Score: 0</div>
        <button onclick="location.reload()" style="background:#ef4444; color:white; border:none; padding:8px 12px; border-radius:8px; font-size:12px;">Reset</button>
    </div>

    <div id="game-section">
        <canvas id="gameCanvas"></canvas>
        <div id="fail-overlay">
            <h1>FAILED</h1>
            <button class="btn" style="background:#ef4444; color:white;" onclick="location.reload()">RETRY</button>
        </div>
        <div class="progress-container"><div class="progress-fill" id="p-bar-main"></div></div>
        <p style="color: #94a3b8; font-size: 12px;"><b>Tap and Hold</b> to spray!</p>
    </div>

    <div id="quiz-section" class="checkpoint-box">
        <h3 style="margin:0;">Stage 1: Equipment</h3>
        <div class="diagram-wrapper">
            <div class="part-target" data-answer="HANDLE" style="top:38px; left:125px;"></div>
            <div class="part-target" data-answer="LEVER" style="top:80px; left:152px;"></div>
            <div class="part-target" data-answer="PIN" style="top:65px; left:135px;"></div>
            <div class="part-target" data-answer="PRESSURE GAUGE" style="top:75px; left:118px;"></div>
            <div class="part-target" data-answer="HOSE" style="top:125px; left:80px;"></div>
            <div class="part-target" data-answer="NOZZLE" style="top:245px; left:90px;"></div>
        </div>
        <div class="choice-grid" id="s1-choices">
            <div class="choice-box-uniform touch-draggable" id="L1">PRESSURE GAUGE</div>
            <div class="choice-box-uniform touch-draggable" id="L2">LEVER</div>
            <div class="choice-box-uniform touch-draggable" id="L3">NOZZLE</div>
            <div class="choice-box-uniform touch-draggable" id="L4">PIN</div>
            <div class="choice-box-uniform touch-draggable" id="L5">HOSE</div>
            <div class="choice-box-uniform touch-draggable" id="L6">HANDLE</div>
        </div>
        <button id="quizReturnBtn" class="btn btn-green" onclick="returnToGame('quiz-section')">CONTINUE</button>
    </div>

    <div id="phone-section" class="checkpoint-box">
        <h3>Stage 2: Emergency</h3>
        <div class="iphone-frame">
            <div class="iphone-notch"></div>
            <div class="iphone-screen">
                <div class="iphone-display" id="phone-display"></div>
                <div class="iphone-grid">
                    <div class="iphone-key" onclick="pressKey('1')">1</div><div class="iphone-key" onclick="pressKey('2')">2</div><div class="iphone-key" onclick="pressKey('3')">3</div>
                    <div class="iphone-key" onclick="pressKey('4')">4</div><div class="iphone-key" onclick="pressKey('5')">5</div><div class="iphone-key" onclick="pressKey('6')">6</div>
                    <div class="iphone-key" onclick="pressKey('7')">7</div><div class="iphone-key" onclick="pressKey('8')">8</div><div class="iphone-key" onclick="pressKey('9')">9</div>
                    <div class="iphone-key" style="color:#ff3b30; font-size:12px;" onclick="clearPhone()">DEL</div><div class="iphone-key" onclick="pressKey('0')">0</div><div class="iphone-key">#</div>
                </div>
                <button class="iphone-call" onclick="makeCall()">üìû</button>
            </div>
        </div>
        <div id="phone-msg" style="margin-top:10px; font-weight:bold; font-size:12px;"></div>
    </div>

    <div id="grid-stage-section" class="checkpoint-box">
        <h2 id="grid-title" style="font-size:18px;"></h2>
        <div class="person-container">
            <div class="person-drag touch-draggable" id="person-logic">üö∂</div>
            <div style="background:#3b82f6; color:white; padding:5px 10px; border-radius:20px; font-weight:bold; font-size:12px;">Drag Me</div>
        </div>
        <div class="drop-grid" id="main-drop-grid"></div>
        <div id="grid-msg" style="margin-top:10px; font-weight:bold; font-size:12px;"></div>
        <button id="gridNextBtn" class="btn btn-green" onclick="returnToGame('grid-stage-section')">CONTINUE</button>
    </div>

    <div id="pass-section" class="checkpoint-box">
        <h3 style="margin:0;">Stage 4: PASS</h3>
        <div style="text-align:left; line-height:1.8; font-size:13px; background:#f8fafc; padding:10px; border-radius:10px;">
            Pull the <span class="blank-inline" id="drop-PIN"></span>,<br>
            Aim the <span class="blank-inline" id="drop-NOZZLE"></span> at base,<br>
            Squeeze the <span class="blank-inline" id="drop-LEVER"></span>,<br>
            <span class="blank-inline" id="drop-SWEEP"></span> from side to side.
        </div>
        <div id="pass-bank" class="choice-grid"></div>
        <button id="passReturnBtn" class="btn btn-green" onclick="returnToGame('pass-section')">CONTINUE</button>
    </div>

    <div id="logic-box" class="checkpoint-box">
        <h2 id="logic-title" style="font-size:18px;"></h2>
        <p id="logic-desc" style="font-size:12px;"></p>
        <div id="logic-body"></div>
        <div id="logic-msg" style="margin-top:10px; font-weight:bold; font-size:12px;"></div>
        <button id="logicNextBtn" class="btn btn-green" onclick="returnToGame('logic-box')">CONTINUE</button>
    </div>

    <div id="congrats" class="checkpoint-box">
        <h1 style="color:#2563eb; font-size:24px;">HERO! üèÜ</h1>
        <p style="font-size: 14px;">Mission Accomplished!</p>
        <button class="btn" style="background:#2563eb; color:white;" onclick="location.reload()">REPLAY</button>
    </div>

<script>
/** --- MOBILE TOUCH POLYFILL --- **/
let activeDragElement = null;
let offset = { x: 0, y: 0 };
let originalPos = { x: 0, y: 0 };

function setupTouchListeners() {
    document.addEventListener('touchstart', handleTouchStart, { passive: false });
    document.addEventListener('touchmove', handleTouchMove, { passive: false });
    document.addEventListener('touchend', handleTouchEnd, { passive: false });
}

function handleTouchStart(e) {
    if (e.target.classList.contains('touch-draggable')) {
        e.preventDefault();
        activeDragElement = e.target;
        const touch = e.touches[0];
        const rect = activeDragElement.getBoundingClientRect();
        offset.x = touch.clientX - rect.left;
        offset.y = touch.clientY - rect.top;
        originalPos.x = rect.left;
        originalPos.y = rect.top;
        activeDragElement.style.position = 'fixed';
        activeDragElement.style.zIndex = '2000';
    }
}

function handleTouchMove(e) {
    if (!activeDragElement) return;
    e.preventDefault();
    const touch = e.touches[0];
    activeDragElement.style.left = (touch.clientX - offset.x) + 'px';
    activeDragElement.style.top = (touch.clientY - offset.y) + 'px';
}

function handleTouchEnd(e) {
    if (!activeDragElement) return;
    const touch = e.changedTouches[0];
    const dropTarget = document.elementFromPoint(touch.clientX, touch.clientY);
    
    // Logic to check if dropped over a target circle or zone
    checkDropCollision(activeDragElement, touch.clientX, touch.clientY);

    activeDragElement.style.position = 'static';
    activeDragElement.style.zIndex = 'auto';
    activeDragElement = null;
}

function checkDropCollision(el, x, y) {
    // Stage 1 Collision
    const targets = document.querySelectorAll('.part-target, .drop-zone, .blank-inline');
    targets.forEach(t => {
        const rect = t.getBoundingClientRect();
        if (x > rect.left && x < rect.right && y > rect.top && y < rect.bottom) {
            // Standard Drag Logic Trigger
            const dataText = el.innerText;
            const targetAnswer = t.getAttribute('data-answer');
            
            // Handle Stage 1
            if (targetAnswer === dataText) {
                t.innerText = dataText;
                t.classList.add('filled-correct');
                el.style.display = 'none';
                if(document.querySelectorAll('.checkpoint-box[style*="block"] .part-target:not(.filled-correct)').length === 0) document.getElementById("quizReturnBtn").style.display="block";
            }
            
            // Handle Grid Stages
            if (t.classList.contains('drop-zone')) {
                processGridDrop(el, t);
            }
            
            // Handle PASS Stage
            if (t.id.startsWith('drop-')) {
                const required = t.id.replace('drop-', '');
                if (required === dataText) {
                    t.innerText = dataText;
                    t.style.border = 'none';
                    el.style.display = 'none';
                    pc++; if(pc===4) document.getElementById("passReturnBtn").style.display="block";
                }
            }
        }
    });
}

/** --- EMPLOYEE LOOKUP LOGIC --- **/
const employeeData = { "1001": "Juan Dela Cruz", "1002": "Maria Santos", "12345": "Admin Hero" };
let currentPlayerName = "";

function searchEmployee() {
    const inputId = document.getElementById('emp-id-input').value.trim();
    if (employeeData[inputId]) {
        currentPlayerName = employeeData[inputId];
        document.getElementById('player-name-span').innerText = currentPlayerName;
        document.getElementById('search-result').style.display = "block";
        document.getElementById('start-mission-btn').style.display = "block";
        document.getElementById('search-btn').style.display = "none";
    } else { document.getElementById('error-msg').style.display = "block"; }
}

function initGame() {
    document.getElementById('login-screen').style.display = "none";
    document.getElementById('top-bar').style.display = "flex";
    startGame();
}

/** --- GAME ENGINE --- **/
const canvas = document.getElementById("gameCanvas"); const ctx = canvas.getContext("2d"); 
canvas.width = 320; canvas.height = 200; // Scaled down for mobile
let score = 0, gameActive = false, isSpraying = false, fires = [], particles = [], cp = Array(11).fill(false), stagesFinished = 0;

function startGame() { document.getElementById("game-section").style.display="block"; setupTouchListeners(); gameActive=true; loop(); }

function update() {
    if (!gameActive) return;
    if (isSpraying) for(let i=0;i<3;i++) particles.push({x:60,y:140,vx:5+Math.random()*3,vy:(Math.random()-0.5)*3,life:15,size:3+Math.random()*5});
    for(let i=particles.length-1;i>=0;i--){particles[i].x+=particles[i].vx; particles[i].y+=particles[i].vy; if(--particles[i].life<=0)particles.splice(i,1);}
    if(Math.random()<0.04) fires.push({x:320,y:150});
    for(let i=fires.length-1;i>=0;i--){ 
        fires[i].x -= 2; 
        particles.forEach(p=>{
            if(fires[i]&&p.x>fires[i].x && p.x<fires[i].x+30 && p.y>fires[i].y && p.y<fires[i].y+30){
                fires.splice(i,1); score++; document.getElementById("score").innerText="Score: "+score; checkCheckpoint();
            }
        });
        if(fires[i] && fires[i].x < 60) { 
            fires.splice(i, 1);
            if(score > 0) score--;
            document.getElementById("score").innerText="Score: "+score;
        }
    }
}

function draw(){
    ctx.clearRect(0,0,320,200); ctx.fillStyle="#1e293b"; ctx.fillRect(0,180,320,20); 
    ctx.fillStyle="#ffffff"; particles.forEach(p=>{ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill();}); 
    ctx.fillStyle="#ef4444"; ctx.fillRect(30,130,25,40); 
    ctx.font="25px Arial"; fires.forEach(f=>ctx.fillText("üî•",f.x,f.y+20));
}

function loop(){if(gameActive){update(); draw(); requestAnimationFrame(loop);}}

// Mobile Touch Control for Spraying
window.addEventListener("touchstart", (e) => { if(gameActive && e.target.id === 'gameCanvas') isSpraying = true; });
window.addEventListener("touchend", () => { isSpraying = false; });
// Desktop Fallback
window.addEventListener("mousedown", () => { if(gameActive) isSpraying = true; });
window.addEventListener("mouseup", () => { isSpraying = false; });

function checkCheckpoint() {
    const s = score;
    if (s===10 && !cp[0]) { cp[0]=true; showCP("quiz-section"); }
    else if (s===20 && !cp[1]) { cp[1]=true; showCP("phone-section"); }
    else if (s===30 && !cp[2]) { cp[2]=true; setupGrid(3); }
    else if (s===40 && !cp[3]) { cp[3]=true; setupPass(); }
    else if (s===50 && !cp[4]) { cp[4]=true; setupRace(); }
    else if (s===60 && !cp[5]) { cp[5]=true; setupCode(6); }
    else if (s===70 && !cp[6]) { cp[6]=true; setupCode(7); }
    else if (s===80 && !cp[7]) { cp[7]=true; setupCode(8); }
    else if (s===90 && !cp[8]) { cp[8]=true; setupGrid(9); }
    else if (s===100 && !cp[9]) { cp[9]=true; setupGrid(10); }
}

function showCP(id) { gameActive=false; document.getElementById("game-section").style.display="none"; document.getElementById(id).style.display="block"; }
function returnToGame(id) { stagesFinished++; document.getElementById("p-bar-main").style.width=(stagesFinished/10*100)+"%"; if(stagesFinished===10){document.getElementById(id).style.display="none"; document.getElementById("congrats").style.display="block"; return;} document.getElementById(id).style.display="none"; document.getElementById("game-section").style.display="block"; fires=[]; gameActive=true; loop(); }

// PASS & GRID TOUCH LOGIC
let pc = 0;
function setupPass(){
    showCP("pass-section"); const bank = document.getElementById("pass-bank"); bank.innerHTML="";
    const words = ["PIN", "NOZZLE", "LEVER", "SWEEP"].sort(()=>Math.random()-0.5);
    words.forEach((w,i)=> bank.innerHTML += `<div class="choice-box-uniform touch-draggable" style="width:70px; font-size:10px;">${w}</div>`);
    pc = 0;
}

function processGridDrop(el, targetZone) {
    // Shared Logic for Stage 3, 9, 10
    const dataText = el.innerText;
    if (targetZone.classList.contains('filled-correct-grid')) return;

    // Correctness checks based on current title/stage
    let isCorrect = false;
    if (document.getElementById('grid-title').innerText.includes("Earthquake")) {
        const sequence = ["üôá DUCK", "üõ°Ô∏è COVER", "‚úä HOLD"];
        if (targetZone.innerText === sequence[gStep] && dataText === sequence[gStep]) isCorrect = true;
    } else {
        // Assembly areas
        if (targetZone.getAttribute('data-is-correct') === 'true' && dataText === targetZone.innerText) isCorrect = true;
    }

    if (isCorrect) {
        targetZone.classList.add('filled-correct-grid');
        targetZone.innerText = "‚úÖ " + dataText;
        el.style.display = 'none';
        // Check for stage completion...
    }
}

// Phone stage functions
function pressKey(n){const d=document.getElementById("phone-display"); if(d.innerText.length<4) d.innerText+=n;}
function clearPhone(){document.getElementById("phone-display").innerText="";}
function makeCall(){ if(document.getElementById("phone-display").innerText==="1111"){ document.getElementById("phone-display").innerText="..."; setTimeout(()=>returnToGame("phone-section"), 1500);} }

// Initial function to start mobile setup
setupTouchListeners();
</script>
</body>
</html>
